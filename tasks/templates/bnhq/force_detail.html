{% extends "dashboard/css.html" %}
{% load widget_tweaks %}
{% load dict_extras %}
{% block title %}All Forces{% endblock %}

{% block content %}

<main class="p-6 space-y-6">

<table class="bg-white table-auto w-full border">
<thead>
<tr class="bg-amber-400 px-4 py-2 text-xl">
    <th>Ser</th>
    <th>Per No</th>
    <th>Rank</th>
    <th>Name</th>
    <th>Force</th>
    <th>Phone</th>
    <th>Email</th>
    <th>Company</th>
    <th>Detail</th>
    <th>Posting</th>
</tr>
</thead>

<tbody>
{% for m in members %}
<tr class="text-center border font-sm-semibold">
    <td>{{ forloop.counter }}</td>
    <td>{{ m.no }}</td>
    <td>{{ m.get_rank_display }}</td>
    <td>{{ m.name }}</td>
    <td>{{ m.force }}</td>
    <td>{{ m.phone }}</td>
    <td>{{ m.email }}</td>

    <!-- Company display -->
    <td class="company-name font-semibold">
        {{ m.get_company_display|default:"---" }}
    </td>

    <!-- View -->
    <td>
        <a href="{% url 'address' m.id %}"
           class="bg-green-500 text-white px-3 py-1 rounded hover:bg-amber-300">
           View
        </a>
    </td>

    <!-- AJAX Assign -->
    <td>
        <form class="assign-form flex gap-2 items-center">
            {% csrf_token %}
            {% with form=forms_dict|get_item:m.id %}
                {{ form.company }}
            {% endwith %}
            <input type="hidden" name="member_id" value="{{ m.id }}">
            <button type="button"
                class="assign-btn bg-blue-600 text-white px-3 py-1 rounded hover:bg-purple-400">
                Assign
            </button>
        </form>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

</main>

<!-- ================= RAB-1 OUT LIST ================= -->
<div class="mt-12">
    <h2 class="bg-amber-400 text-2xl font-bold text-center text-white">
        RAB-1 Out List
    </h2>

    <table class="bg-white table-auto w-full border">
        <thead>
            <tr class="bg-red-400 text-xl">
                <th>Ser</th>
                <th>Per No</th>
                <th>Rank</th>
                <th>Name</th>
                <th>Force</th>
                <th>Out Date</th>
            </tr>
        </thead>
        <tbody id="out-table-body">
            {% for o in out_members %}
            <tr class="text-center border bg-red-50">
                <td>{{ forloop.counter }}</td>
                <td>{{ o.no }}</td>
                <td>{{ o.get_rank_display }}</td>
                <td>{{ o.name }}</td>
                <td>{{ o.force }}</td>
                <td class="font-semibold text-red-700">
                    {{ o.out_date|date:"d-m-Y" }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-gray-500">
                    No OUT members
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.querySelectorAll(".assign-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const form = this.closest(".assign-form");
        const row = this.closest("tr");
        const formData = new FormData(form);

        fetch("", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert("Assign failed!");
                return;
            }

            if (data.is_out) {
                const outTable = document.getElementById("out-table-body");
                const newRow = document.createElement("tr");
                newRow.className = "text-center border bg-red-50";
                newRow.innerHTML = `
                    <td>*</td>
                    <td>${row.children[1].innerText}</td>
                    <td>${row.children[2].innerText}</td>
                    <td>${row.children[3].innerText}</td>
                    <td>${row.children[4].innerText}</td>
                    <td class="font-semibold text-red-700">${data.out_date}</td>
                `;
                outTable.appendChild(newRow);

                // main list থেকে remove
                row.remove();
            } else {
                row.querySelector(".company-name").innerText = data.company_name;
                row.classList.add("bg-green-100");
            }
        });
    });
});
</script>

{% endblock %}
